pipeline{
    agent any
    stages{
        stage('webhook'){
            steps{
                echo 'succesfull build with webhook and ngroK;)'
            }
        }
        stage('MVN Build'){
            steps{
               sh 'mvn clean install'
               sh 'mvn -version'

            }
        }

        stage('MVN Sonarqube'){
            steps{
               sh 'mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=Amal123456789@ -Dmaven.test.skip=true'
 ]            }
        }
        stage('MVN Test'){
              steps{
                sh 'mvn test'
                junit(testResults: 'target/surefire-reports/*.xml', allowEmptyResults : true)
              }
        }
        stage('Collect JaCoCo Coverage') {
               steps{
                 jacoco(execPattern: '**/target/jacoco.exec')
            }
        }


       
       stage('Build Docker Image') {
                steps {
                    script {
                          sh 'docker build -t AmalKlouz/5SAE6_5_gestion_station_ski .'
                       }
                   }
               }


      stage('push Docker Image') {
            stage('Deploy with Docker Compose') {
               steps {
                  script {
                   sh 'docker-compose up -d'
                   }
          }
      }
      stage('Email') {
                  steps {
                      script {
                          emailext subject: 'Build Status',
                                   body: 'The build and deployment are completed.',
                                   to: 'amal.klouz@esprit.tn',
                                   attachLog: true
                      }
                  }
              }
    }
}